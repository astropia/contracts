# 笔记

## Astropia

[Astropia.sol](./Astropia.sol)是管理游戏几乎所有资产（包括非同质化的角色、装备及同质化的游戏内货币、点数等）的[ERC1155](https://eips.ethereum.org/EIPS/eip-1155)智能合约，允许经过批准的（游戏逻辑）合约铸造新的NFT/FT。

### Metadata 元数据

为了拓展游戏资产在链上合约间交互时的内容，在合约中对每一个NFT挂载一个`uint160` * 256大小的metadata（原则上也允许对FT的类型挂载一个metadata，但是可能没有太大的实际意义）。这些数据允许Astropia合约内标记为`isGameZone`的其他合约对其进行修改。对于每一类资产，应当在其JSON Schema中描述其metadata中储存的数据的含义；对于所有资产，应当在设计metadata布局时尽量保证同样的 mIndex(0 ~ 255) 对应的`uint160`数据的含义尽量相似。

> 选择`uint160`作为储存metadata的格式主要是考虑可以直接和`address`类型转换，这样在metadata中储存地址信息（可以预见到这会经常发生）时更加直接，而避免在metadata的格式定义时还要考虑数据的偏移位置。

| mIndex | 名称 | 规则 |
| - | - | - |
| 0 | 初始信息 | 仅铸币合约可以设置的信息，但一般情况下也不建议创世合约对其进行修改。 |
| 254 | 铸币合约地址 | 仅铸币时会被自动设置为铸币合约地址，仅有铸币合约有权限设置NFT的m0创始信息。 |
| 255 | metadata锁 | 当该信息为0时，对于修改metadata的权限不做限制；反之，则只允许该信息对应的合约/账户对于所有metadata进行更改。当更新该信息时，仅允许被设置为0，或者`msg.sender`值，以防死锁。 |

### Token ID规则

为管理和区分不同Token，合约中使用`uint256`格式记录的Token Type ID加以区分。规定其值的最高位索引为1，最低位索引为256，对ID中各位信息的含义及铸币合约应该遵守的规范进行规定：

| 位置 | 长度 | 名称 | 规则 |
| - | - | - | - |
| 1 | 1 | NFT/FT标记 | 1表示当前Token为NFT，0为FT |
| 2-4 | 3 | 保留位 | 在无新规定之前均为0 |
| 5-112 | 108 | Token类别 | Token的名称/类别ID，铸币合约必须保证同一类FT/NFT的类别ID完全一致，不同FT/NFT必须有不同的类别ID |
| 113-128 | 16 | 铸币合约索引 | 铸币合约必须保证该字段均为0。对于NFT，Astropia会根据铸币合约的索引来填充该字段 |
| 129-256 | 128 | NFT ID | NFT的代币ID。对于FT该字段均为0，而NFT应当避免该字段全为0 |

根据规则，高112位为Token Type信息位，低144位为NFT信息位，并且强制包含了16位的铸币来源信息。

#### Example

`0x8000000000417374726f706961720001c8dbe2f0931e6e922d765e0aef396e8c`
该ID代表一个特定种类的唯一NFT：
* `0x8`为最高位的NFT标记
* `0x000000000417374726f70696172`为Token类别ID
* `0x0001`为铸币合约索引
* `0xc8dbe2f0931e6e922d765e0aef396e8c`为NFT内唯一ID

`0x0000000000417374726f70696172000000000000000000000000000000000000`
该ID代表一类特定种类的FT：
* `0x0`为最高位的FT标记
* `0x000000000417374726f70696172`为Token类别ID
* `0x000000000000000000000000000000000000`为FT强制为0字段

---

## CardPool #1

[CardPool_1_Origin.sol](./CardPool_1_Origin.sol)是第一期卡池的铸币合约，仅生产一种NFT：Asrtopiar——即游戏内的初始人物卡牌。

> 由于还未获取具体的世界观和数值维度等设定，暂时测试中规定人物的元数据仅有一个【能量值】，储存在m1的元数据字段
